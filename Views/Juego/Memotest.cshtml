@{
    ViewData["Title"] = "Memotest";
    bool mostrarSeleccion = ViewBag.MostrarSeleccion == true;
    int? nivel = ViewBag.Nivel;

    var cartas = new string[0];
    var encontradas = new List<int>();

    if (!mostrarSeleccion && nivel.HasValue)
    {
        cartas = Context.Session.GetString("CartasMezcladas")?.Split(',') ?? new string[0];
        encontradas = Context.Session.GetString("Encontradas")?
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(int.Parse).ToList() ?? new List<int>();
    }
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<header class="custom-header">
    <nav class="navbar navbar-expand-lg navbar-dark custom-nav">
        <div class="container-fluid">

            <img class="logo-header" src="/img/Home/logoSVG.svg" alt="logo">

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-3">
                    <li class="nav-item"><a class="nav-link" href="/Home/Home">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/Juego/Index">Juego</a></li>
                    <li class="nav-item"><a class="nav-link" href="/Comunidades/Grupos">Grupos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/Tramite/">Trámites</a></li>
                    <li class="nav-item"><a class="nav-link" href="/Mapa/Index">Mapa</a></li>
                    <li class="nav-item"><a class="nav-link" href="/Noticias/Noticias">Noticias</a></li>
                </ul>
            </div>

            <button class="menu-btn fixed-btn" id="menuBtn">☰</button>
        </div>
    </nav>

    <div id="sideMenu" class="side-menu">
        <button id="closeBtn" class="close-menu-btn">←</button>

        <div class="side-menu-links">
            <a href="/Home/Home">Home</a>
            <a href="@Url.Action("Index", "Juego")">Juegos</a>
            <a href="/Comunidades/Grupos">Grupos</a>
            <a href="/Tramite/">Trámites</a>
            <a href="/Mapa/Index">Mapa</a>
            <a href="/Noticias/Noticias">Noticias</a>
            <a href='@Url.Action("Perfil", "Usuario")'>Perfil</a>
            <a href='@Url.Action("Noti", "Usuario")'>Notificaciones</a>
            <a href='@Url.Action("ChatBot", "ChatBot")'>ChatBot</a>
            <a href='@Url.Action("CerrarSesion", "Usuario")'>Cerrar Sesión</a>
        </div>
    </div>
</header>


@if (mostrarSeleccion)
{
    <div class="memotest-container">
        <div class="memotest-content">
            <a href="@Url.Action("Index", "Juego")" class="volver-link">←</a>

            <h2>Memotest</h2>

            <div class="instrucciones">
                <h3>¿Cómo jugar?</h3>
                <p>
                    El objetivo del juego es encontrar todos los pares de cartas.
                    Al hacer clic en dos cartas podrás ver si coinciden.
                </p>
            </div>

            @{
                var progreso = ViewBag.Progreso as List<int> ?? new List<int>();
            }

            <div class="niveles-botones">

                <!-- NIVEL 1 -->
                <a href="/Juego/Memotest?nivel=1"
                   class="btn-nivel @(progreso.Contains(1) ? "completado" : "actual")">
                    Nivel 1
                </a>

                <!-- NIVEL 2 -->
                <a href="/Juego/Memotest?nivel=2"
                   class="btn-nivel @(
                        progreso.Contains(1)
                            ? (progreso.Contains(2) ? "completado" : "actual")
                            : "bloqueado"
                    )">
                    Nivel 2
                </a>
            </div>
        </div>
    </div>
}
else
{
    <div class="memotest-container">
        <div class="memotest-content">

            <a href="@Url.Action("Memotest", "Juego")" class="volver-link">←</a>

            <h2>Memotest - Nivel @nivel</h2>

            <div class="memotest-grid">
                @for (int i = 0; i < cartas.Length; i++)
                {
                    bool esEncontrada = encontradas.Contains(i);

                    <div class="carta @(esEncontrada ? "encontrada" : "")" data-index="@i">
                        <div class="inner">
                            <img class="cara frente" src="/img/memotest/@cartas[i]" alt="Carta" />
                            <img class="cara dorso" src="/img/memotest/dorso.png" alt="Dorso" />
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
}

<link rel="stylesheet" href="/css/site.css" />

@section Scripts {
    <script src="/js/memotest.js"></script>
}
