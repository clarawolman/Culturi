@{
    ViewData["Title"] = "Memotest";
    bool mostrarSeleccion = ViewBag.MostrarSeleccion == true;
    int? nivel = ViewBag.Nivel;

    var cartas = new string[0];
    var encontradas = new List<int>();

    if (!mostrarSeleccion && nivel.HasValue)
    {
        cartas = Context.Session.GetString("CartasMezcladas")?.Split(',') ?? new string[0];
        encontradas = Context.Session.GetString("Encontradas")?
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(int.Parse).ToList() ?? new List<int>();
    }
}

@if (mostrarSeleccion)
{
    <div class="memotest-container">
        <div class="memotest-content">
            <h2>Memotest</h2>
            <div class="instrucciones">
                <h3>Â¿CÃ³mo jugar?</h3>
                <p>
                    El objetivo del juego es encontrar todos los pares de cartas.
                    Haz clic en dos cartas para voltearlas. Si coinciden, se quedarÃ¡n descubiertas.
                    Si no coinciden, se darÃ¡n vuelta nuevamente.
                </p>
            </div>

            <div class="niveles-seleccion">
                <h3>Selecciona un nivel:</h3>
                <div class="niveles-botones">
                    <a href="@Url.Action("Memotest", "Juego", new { nivel = 1 })" class="btn-nivel"><span>Nivel 1</span></a>
                    <a href="@Url.Action("Memotest", "Juego", new { nivel = 2 })" class="btn-nivel"><span>Nivel 2</span></a>
                    <a href="@Url.Action("Memotest", "Juego", new { nivel = 3 })" class="btn-nivel"><span>Nivel 3</span></a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="memotest-container">
        <div class="memotest-content">
            <h2>Memotest - Nivel @nivel</h2>

            <div class="memotest-grid">
                @for (int i = 0; i < cartas.Length; i++)
                {
                    bool esEncontrada = encontradas.Contains(i);

                    <div class="carta @(esEncontrada ? "encontrada" : "")" data-index="@i">
                        <div class="inner">
                            <img class="cara frente" src="/img/memotest/@cartas[i]" alt="Carta" />
                            <img class="cara dorso" src="/img/memotest/dorso.png" alt="Dorso" />
                        </div>
                    </div>
                }
            </div>

            @if (encontradas.Count == cartas.Length && cartas.Length > 0)
            {
                <div class="text-center mt-4">
                    <h3>ðŸŽ‰ Â¡Felicitaciones! Encontraste todos los pares ðŸŽ‰</h3>
                    
                    <form asp-action="ReiniciarMemotest" method="post" style="display:inline;">
                        <button type="submit" class="btn btn-success">Jugar de nuevo</button>
                    </form>

                    <a href="@Url.Action("Memotest", "Juego")"
                       class="btn btn-primary" style="display:inline;">
                        Volver a selecciÃ³n de nivel
                    </a>
                </div>
            }

            <div class="text-center mt-3">
                <a href="@Url.Action("Memotest", "Juego")" class="btn btn-secondary">Volver a niveles</a>
            </div>
        </div>
    </div>
}

<link rel="stylesheet" href="/css/memotest.css" />
@section Scripts {
    <script src="/js/memotest.js"></script>
}
