@{
    ViewData["Title"] = "Memotest";
    var cartas = Context.Session.GetString("CartasMezcladas")?.Split(',') ?? new string[0];
    var volteadas = Context.Session.GetString("Volteadas")?.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(int.Parse).ToList() ?? new List<int>();
    var encontradas = Context.Session.GetString("Encontradas")?.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(int.Parse).ToList() ?? new List<int>();
}

<div class="memotest-container">
    <div class="memotest-content">
        <h2>ðŸ§  Encuentra los pares correctos</h2>
        <div class="memotest-grid">
            @for (int i = 0; i < cartas.Length; i++)
            {
                var mostrarCarta = volteadas.Contains(i) || encontradas.Contains(i);
                var imagenMostrar = mostrarCarta ? cartas[i] : "reverso.jpg";
                <div class="card-container">
                    <form asp-action="TocarCarta" method="post" class="m-1">
                        <input type="hidden" name="index" value="@i" />
                        <button type="submit" class="btn p-0 @(mostrarCarta ? "disabled" : "")" @(mostrarCarta ? "disabled" : "")>
                            <img src="~/images/cartas/@imagenMostrar" class="carta-memotest" alt="Carta" />
                        </button>
                    </form>
                </div>
            }
        </div>

        @if (encontradas.Count == cartas.Length)
        {
            <div class="text-center mt-4">
                <h3>ðŸŽ‰ Â¡Felicitaciones! Encontraste todos los pares ðŸŽ‰</h3>
                <form asp-action="ReiniciarMemotest" method="post">
                    <button type="submit" class="btn btn-success">Jugar de nuevo</button>
                </form>
            </div>
        }
    </div>
</div>

<audio id="audio-carta" src="~/audio/abrirCartaSound.mp3"></audio>
<audio id="audio-victory" src="~/audio/victory.mp3"></audio>

<script>
document.querySelectorAll('.memotest-grid form').forEach(form => {
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const audio = document.getElementById('audio-carta');
    if (audio) { audio.currentTime = 0; audio.play(); }

    const formData = new FormData(form);
    fetch(form.action, {
      method: form.method,
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(() => {
      window.location.reload();
    });
  });
});

const btnContinuar = document.getElementById('btn-continuar-memotest');
if (btnContinuar) {
  document.getElementById('audio-victory').play().catch(e => console.log(e));
  btnContinuar.addEventListener('click', function() {
    const audio = document.getElementById('audio-victory');
    if (audio) { audio.currentTime = 0; audio.play(); }
  });
}
</script>

<style>
.memotest-container {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  margin-top: 40px;
}

.memotest-grid {
  display: grid;
  grid-template-columns: repeat(4, 120px);
  gap: 12px;
  justify-content: center;
}

.carta-memotest {
  width: 120px;
  height: 120px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.2s;
}
.carta-memotest:hover {
  transform: scale(1.08);
}
</style>